## 定制化ntp-server

为了实现一级分行的6台宿主机之间的系统时间自动同步，以及二级分行的3台宿主机也需要时间同步，我们采用了NTP协议。然而，由于一级和二级分行之间的防火墙阻止了NTP协议的通信，我们采用了一种特定的方法。在这种方法中，二级分行提供了北向接口，但仅限一级分行访问。一级分行充当上游，而二级分行则扮演下游的角色。上游一级分行可以将自身的时间信息下发给下游二级分行，并让下游进行相应的时间调整，从而实现时间同步。

我们选择使用Chrony来实现此目标，并采用1主n从模式。我们将主和从部署为Kubernetes Deployment，并在Deployment的安全上下文中添加SYS_TIME和SYS_NICE这两个Linux权限。同时，我们还使用Pod反亲和性，以确保每个Deployment与节点之间保持一对一的关系。

时间同步对于系统稳定性和性能至关重要，具体体现在以下几个方面：

时间同步的价值：

数据一致性： 时间同步确保了不同系统和设备之间的数据一致性。在分布式系统中，如果不同组件的时间不一致，可能会导致数据不同步，损害数据完整性和可靠性。
安全性： 时间同步对于安全系统和日志记录至关重要。时间戳可以用于确保事件发生的顺序，以及对于安全审计和事件跟踪的准确性。
计时操作的可靠性： 许多计时操作，如定时任务、证书的有效期、安全协议等都依赖于准确的时间信息。时间同步确保这些操作的可靠性。
调试和故障排除： 当系统发生故障时，时间同步的日志和时间戳能够帮助开发人员更轻松地进行调试和故障排除。

没有时间同步可能导致的后果：

数据不一致： 如果不同部分的系统使用不同的时间标准，可能会导致数据不一致，从而引发混乱和错误。
安全漏洞： 时间不同步可能导致时间戳不准确，从而影响安全协议和审计的有效性，使系统容易受到攻击。
计时操作的错误： 没有时间同步可能导致计时操作的错误，如定时任务执行不当或证书的不正确生成和验证。
调试困难： 在没有准确时间戳的情况下，故障排除和问题调查变得更加困难，增加了维护和支持的复杂性。

综上所述，时间同步在分布式系统和网络中扮演着至关重要的角色，对于数据完整性、安全性和系统可靠性都具有重要价值。确保系统的时间同步是维护系统稳定性和性能的关键因素之一。

```sh
##
# 安装命令, 在主节点执行
#   --set workerDeployment.replicas=<k3s宿主机个数减去一>
##
helm install ntp-server http://helm.iottepa.cn:32021/charts/uap-ntp-server-{版本}.tgz --set workerDeployment.replicas=2

##
# 手动调整时间，注意k3s的所有宿主机需要消耗数分钟的时间才能自动同步系统时间
##
kubectl exec -it deployment/ntp-server-master -- sh -c "chronyc manual on && chronyc settime 16:30:05"
```